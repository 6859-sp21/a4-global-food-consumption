

<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>


<head> 
<h1 class = "center" > Global meat consumption and CO2 emission </h1> 
<link rel="stylesheet" href="style.css" />
</head>

<div id="myYear" style="width:900px;height:100px;"  class = "center"></div>
<div id="mySliders" class = "center"></div>
<div id="myCanvas1"  class = "center"></div>
<div id="myCanvas2"  class = "center"></div>



<script>
    d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-global-food-consumption/main/_data/emissions.csv").then((csv) => {


    let beef = 0;
    let sheep = 0;
    let poultry = 0;
    let pig = 0;
    let yr = 2018;
    let meat = [
      { index: 0, label: 'beef'},
      { index: 1, label: 'pig'},
      { index: 2, label: 'poultry'},
      { index: 3, label: 'sheep'},
    ];
    
    let legendData = csv.filter( d => d.country === 'USA')
    let data = csv.filter( d => d.year <= yr).filter( d => d.country === 'USA')
    let newdata = data.map(d => ({
        year: d.year, 
        beef: d.beef * (1-beef/100) , 
        pig: d.pig *(1-pig/100), 
        sheep: d.sheep * (1-sheep/100) , 
        poultry: d.poultry * (1-poultry/100) 
    }))



    let carbonData = data.map(d => ({
      year: d.year, 
      beef: d.beef * 60, 
      pig: d.pig * 7, 
      sheep: d.sheep * 24, 
      poultry: d.poultry* 6
    }))

    let newcarbonData = data.map(d => ({
      year: d.year, 
      beef: (d.beef * (1-beef/100)) * 60, 
      pig: d.pig *(1-pig/100)* 7, 
      sheep: d.sheep * (1-sheep/100) * 24, 
      poultry: d.poultry * (1-poultry/100) * 6
    }))

    let legendCarbonData = csv.filter( d => d.country === 'USA').map(d => ({
        year: d.year, 
        beef: d.beef * 60, 
        pig: d.pig * 7, 
        sheep: d.sheep * 24, 
        poultry: d.poultry* 6
    }))


    



    /////////////////////////////////////////////////////////////////////////////////////////////////////
    //YEAR SLIDER
    let yearDiv = d3.select('#myYear');
    let yearMargin = ({top: 50, right: 50, bottom: 30, left: 30, width: 900});
    var slider = d3
       .sliderBottom()
       .min(1990)
       .max(2018)
       .step(1)
       //.ticks(3)
       .width(yearMargin.width - yearMargin.right - yearMargin.left)
       .default(2018)
       .displayValue(true)
       .fill('blue')
       .default(2018)
       .handle(
         d3
         .symbol()
         .type(d3.symbolCircle)
         .size(200)()
       )
       .on('onchange', num => {
            yr = num;
            document.getElementById("myCanvas1").innerHTML = '';
            document.getElementById("myCanvas1").appendChild(chart_actual());

            document.getElementById("myCanvas2").innerHTML = '';
            document.getElementById("myCanvas2").appendChild(chart_emissions());
       });

    yearDiv
        .append('text')
            .text('Year')
            .style("font-size", "18px")
        .append('svg')
        .attr('width', yearMargin.width)
        .attr('height', 100)
        .append('g')
        .attr('transform', `translate(${ 50},30)`)
        .call(slider);



    /////////////////////////////////////////////////////////////////////////////////////
    //MEAT SLIDER
    let div = d3.select('#mySliders');
    meat.forEach((d, i) => {
        var slider = d3
            .sliderBottom()
            .min(0)
            .max(100)
            .step(10)
            .width(100)
            .default(0)
            .ticks(5)
            .displayValue(true)
            .handle(
              d3
              .symbol()
              .type(d3.symbolCircle)
              .size(50)()
            )
            .on('onchange', num => {
              console.log('onchange');
              if (i == 0){beef = num;}
              else if (i == 1){pig = num;}
              else if (i == 2){poultry = num;}
              else if (i == 3){sheep = num;}
              //document.getElementById("myCanvas1").innerHTML = chart_actual().innerHTML;
              document.getElementById("myCanvas1").innerHTML = '';
              document.getElementById("myCanvas1").appendChild(chart_actual());

              document.getElementById("myCanvas2").innerHTML = '';
              document.getElementById("myCanvas2").appendChild(chart_emissions());
              


            });
        //div
        //.append('text')
        //.text(d => 'Reduce ' + meat[i].label + ' by (%)' + "\n");

        div
            .append('svg')
            .attr('width', 220)
            .attr('height', 150)
            .append('g')
            .attr('transform', `translate(${75},10)`)
            .call(slider)
            .append('text')
                .text(d => 'Reduce ' + meat[i].label + ' by (%)')
                .attr('transform', `translate(${-10},50)`);
    });
   
    function chart_actual () {
      legendData = csv.filter( d => d.country === 'USA');
      data = csv.filter( d => d.year <= yr).filter( d => d.country === 'USA');
      newdata = data.map(d => ({
        year: d.year, 
        beef: d.beef * (1-beef/100) , 
        pig: d.pig *(1-pig/100), 
        sheep: d.sheep * (1-sheep/100) , 
        poultry: d.poultry * (1-poultry/100) 
       }));  



      const width = 900;
      const height = 300;
      const margin = {top: 20, right: 120, bottom: 30, left: 60};
     
  
      const keys = csv.columns.slice(3,7);
      const series = d3.stack().keys(keys)(newdata);
      const ori_series = d3.stack().keys(keys)(legendData);
  
      const x = d3.scaleLinear()
        .domain([d3.min(csv, d => d.year), d3.max(csv, d => d.year)])
        .range([margin.left, width - margin.right])
  
      const y = d3.scaleLinear()
        .domain([0, d3.max(ori_series, d => d3.max(d, d => d[1]))]).nice()
        .range([height - margin.bottom, margin.top])
  
      const area = d3.area()
        .x(d => x(d.data.year))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]))
  
      const color = d3.scaleOrdinal()
        .domain(csv.columns.slice(3,7))
        .range(d3.schemeTableau10)
  
      const xAxis = g => g
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x).ticks(10, ".0f"))
        .append('text')
          .attr('text-anchor', 'end')
          .attr('fill', 'black')
          .attr('font-size', '14px')
          .attr('font-weight', 'bold')
          .attr('x', width - margin.right)
          .attr('y', 30)
          .text('Year')
  
      const yAxis = g => g
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y).ticks(5))
        .call(g => g.select(".domain").remove())
        .call(g => g.select(".tick:last-of-type text").clone()
            .attr("x", 3)
            .attr("text-anchor", "start")
            .attr("font-weight", "bold")
            .attr('font-size', '14px')
            .text('Meat Consumption (kg/capita)'))
  
      const svg = d3.create("svg")
          .attr("viewBox", [0, 0, width, height]);
  
      svg.append("g")
        .selectAll("path")
        .data(series)
        .join("path")
          .attr("fill", ({key}) => color(key))
          .attr("d", area)
          .attr("opacity", 0.9)
        .append("title")
          .text(({key}) => key);

      svg.append("g")
          .call(xAxis);

      svg.append("g")
          .call(yAxis);
  
      svg.append('g')
        .attr('transform', `translate(${width - 0.9 * margin.right}, ${height/10})`)
        .call(colorLegend); // <-- our legend helper is invoked just like an axis generato

      return svg.node()
    }

    function chart_emissions() {
        carbonData = data.map(d => ({
          year: d.year, 
          beef: d.beef * 60, 
          pig: d.pig * 7, 
          sheep: d.sheep * 24, 
          poultry: d.poultry* 6
        }))

        newcarbonData = data.map(d => ({
          year: d.year, 
          beef: (d.beef * (1-beef/100)) * 60, 
          pig: d.pig *(1-pig/100)* 7, 
          sheep: d.sheep * (1-sheep/100) * 24, 
          poultry: d.poultry * (1-poultry/100) * 6
        }))

        legendCarbonData = csv.filter( d => d.country === 'USA').map(d => ({
            year: d.year, 
            beef: d.beef * 60, 
            pig: d.pig * 7, 
            sheep: d.sheep * 24, 
            poultry: d.poultry* 6
        }))
        
        const width = 900;
        const height = 300; 
        const margin = {top: 20, right: 120, bottom: 30, left: 60};
  
        const keys = csv.columns.slice(3,7);
        const series = d3.stack().keys(keys)(newcarbonData);
        const ori_series = d3.stack().keys(keys)(legendCarbonData);
  
        const x = d3.scaleLinear()
        .domain([d3.min(csv, d => d.year), d3.max(csv, d => d.year)])
        .range([margin.left, width - margin.right])
  
        const y = d3.scaleLinear()
        .domain([0, d3.max(ori_series, d => d3.max(d, d => d[1]))]).nice()
        .range([height - margin.bottom, margin.top])
  
        const area = d3.area()
        .x(d => x(d.data.year))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]))
  
        const color = d3.scaleOrdinal()
        .domain(csv.columns.slice(3,7))
        .range(d3.schemeTableau10)
  
        const xAxis = g => g
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x).ticks(10, ".0f"))
        .append('text')
            .attr('text-anchor', 'end')
            .attr('fill', 'black')
            .attr('font-size', '14px')
            .attr('font-weight', 'bold')
            .attr('x', width - margin.right)
            .attr('y', 30)
            .text('Year')
  
        const yAxis = g => g
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y).ticks(5))
        .call(g => g.select(".domain").remove())
        .call(g => g.select(".tick:last-of-type text").clone()
            .attr("x", 3)
            .attr("text-anchor", "start")
            .attr("font-weight", "bold")
            .attr('font-size', '14px')
            .text('CO2 Equivalent Emissions per Capita (GHG Emissions per 1kg Produced)'))
  
        const svg = d3.create("svg")
            .attr("viewBox", [0, 0, width, height]);
  
        svg.append("g")
        .selectAll("path")
        .data(series)
        .join("path")
            .attr("fill", ({key}) => color(key))
            .attr("d", area)
            .attr("opacity", 0.9)
        .append("title")
            .text(({key}) => key);

        svg.append("g")
            .call(xAxis);

        svg.append("g")
            .call(yAxis);
  
        svg.append('g')
        .attr('transform', `translate(${width - 0.9 * margin.right}, ${height/10})`)
        .call(colorLegend); 

        return svg.node()
  
    }


    function colorLegend(container) {
          const titlePadding = 14;  // padding between title and entries
          const entrySpacing = 16;  // spacing between legend entries
          const entryRadius = 5;    // radius of legend entry marks
          const labelOffset = 4;    // additional horizontal offset of text labels
          const baselineOffset = 4; // text baseline offset, depends on radius and font size
  
          const keys = csv.columns.slice(3,7)
  
          const color = d3.scaleOrdinal()
          .domain(meat.map(d => d.label))
          .range(d3.schemeTableau10) // try other schemes, too!

          const entries = container.selectAll('g')
            .data(meat)
            .join('g')
              .attr('transform', d => `translate(0, ${titlePadding + d.index * entrySpacing})`);

          const symbols = entries.append('circle')
            .attr('cx', entryRadius) // <-- offset symbol x-position by radius
            .attr('r', entryRadius)
            .attr('fill', d => color(d.label));

          const labels = entries.append('text')
            .attr('x', 2 * entryRadius + labelOffset) // <-- place labels to the left of symbols
            .attr('y', baselineOffset) // <-- adjust label y-position for proper alignment
            .attr('fill', 'black')
            .attr('font-family', 'Helvetica Neue, Arial')
            .attr('font-size', '11px')
            .style('user-select', 'none') // <-- disallow selectable text
            .text(d => d.label);
        }

    let old_chart1 = chart_actual ();
    let old_chart2 = chart_emissions ();


    document.getElementById("myCanvas1").appendChild(old_chart1);
    document.getElementById("myCanvas2").appendChild(old_chart2);
    })
</script>








